<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vue.js-Index.html</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.3.4/vuetify.css" rel="stylesheet"> 
  <link rel="stylesheet" href="https://unpkg.com/vue-nav-tabs/themes/vue-tabs.css">   
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
<div id="app">
  <tgame-list></tgame-list>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@1.3.4/dist/vuetify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.js"></script>
<script src='/lib/moment.js'></script>
<script src="https://unpkg.com/vue-nav-tabs/dist/vue-tabs.js"></script>

<script>
const tGameComponent = Vue.component('tgametable', { 
  template: /* syntax: html */ `
  <div>
    <vue-tabs @tab-change="handleTabChange">
      <template v-for="(filter,i) in filtered">
        <v-tab>
        <div slot="title">{{filter.orgweek}}</div>
      </v-tab>
      </template>
    </vue-tabs>
  </div>  
  `,
 data() {
    return {
      tickets: [],
      tgames: [],
      filtered: [], 
      tabs: '',
      rowsPerPageItems: [4, 8, 12],
      pagination: {  rowsPerPage: 10 }, 
      headers: [ { text: 'Organiser/Round', value: 'orgweek' } 
                ,{ text: 'Home Team', value: 'home_team' }
                ,{ text: 'Away Team', value: 'away_team' }                 
                ,{ text: 'Game Date', value: 'start' } 
                ,{ text: 'Home/Away Score', value: 'home_score' }
                ,{ text: 'Game Winner', value: 'game_winner' }    
                ,{ text: 'Bet Team', value: 'bet_team' }                       
                ,{ text: 'Username', value: 'away_team' }                 
                ,{ text: 'Bet Score', value: 'bet_score' } ],
      totals: { score:0 }                
    }
  },
  filters: { moment: function (date) { return moment(date).format('YYYY-MM-DD'); } },  
  methods: {
    handleTabChange(tabIndex, newTab, oldTab){
      console.log("21) handleTabChange", tabIndex);
      console.log(this.filtered[tabIndex].orgweek);
    },
    filteredItems (key) {  // 2) pool_type
      console.log("101) filteredItem > key:", key);
      const res = this.tgames;
      if (key) { 
        if (key === 'Search') { return res };
        const selectedweek= this.tgames.filter(game => game.orgweek === key);
//        this.sumArray(selectedweek);
        return selectedweek; 
      };
      return res
    },  
    sumArray(myArr) {
      this.totals.score=0;
      for(var i=0; i < myArr.length; i++) {
        this.totals.score += myArr[i].bet_score;
      }
    },      
    removeDuplicates(myArr, prop) {
        return myArr.filter((obj, pos, arr) => {
        return arr.map(mapObj => mapObj[prop]).indexOf(obj[prop]) === pos;
        });
    },   
    getAllData() {
      console.log("10) getAllData");
      var result = 'Getting data from server...'; 
      postdata = { op: "getTicketGames2" };    // all
      this.$http.post('/php/apiTicketGames.php', JSON.stringify(postdata), { 
            headers: { 'Content-Type': 'application/json' }
        }).then(response => {    
            if (response.body === null) { this.tgames=[];  
            } else {              
              this.tgames = response.body.data;
              console.log("11) this.tgames", this.tgames);
              // this.filtered = _.uniqBy(this.tgames, 'orgweek');  problem with keys
              this.filtered=this.removeDuplicates(this.tgames, 'orgweek');
              console.log("13) this.filtered", this.filtered);    
            };
       },   response => { result = 'Failed to load data to server.';
      });
    },
  },    // end of methods
  created() {  
    this.getAllData();
   }
});
new Vue({
  el: '#app',
  components: { 'tgame-list': tGameComponent },
  data: { },
});       // end of Vue
</script>
</body>
</html>